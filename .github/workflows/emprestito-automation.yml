name: Workflow para la ActualizaciÃ³n de datos emprÃ©stito

on:
  workflow_dispatch:
  push:
    branches: [master]
  schedule:
    - cron: "0 0,5,10,15,17,22 * * *"

env:
  API_BASE_URL: ${{ secrets.API_BASE_URL }}

jobs:
  emprestito-pipeline:
    name: ActualizaciÃ³n de datos emprÃ©stito
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‹ Inicializar Logs
        run: |
          echo "ðŸš€ Iniciando pipeline de emprÃ©stito"
          echo "â° $(date)"
          
          echo "==================================================" > execution_log.txt
          echo "WORKFLOW - ActualizaciÃ³n de datos emprÃ©stito" >> execution_log.txt
          echo "==================================================" >> execution_log.txt
          echo "Timestamp Inicio: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> execution_log.txt
          date +%s > start_time.txt
          echo "Ejecutado por: ${{ github.actor }}" >> execution_log.txt
          echo "Trigger: ${{ github.event_name }}" >> execution_log.txt
          echo "Run ID: ${{ github.run_id }}" >> execution_log.txt
          echo "Run Number: ${{ github.run_number }}" >> execution_log.txt
          echo "" >> execution_log.txt

      - name: 1ï¸âƒ£ Crear Tabla de Proyecciones
        id: step1
        run: |
          echo "ðŸ“Š Paso 1 - Crear tabla de proyecciones"
          step1_start=$(date +%s)
          
          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/crear-tabla-proyecciones" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)
          
          echo "ðŸ“‹ HTTP: $http_code | ðŸ“¦ $size_bytes bytes | â±ï¸ ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"
          
          {
            echo "---------------------------------------------------"
            echo "PASO 1 - Crear Tabla de Proyecciones"
            echo "---------------------------------------------------"
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status: $http_code"
            echo "TamaÃ±o respuesta: $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API: ${time_seconds}s"
            echo "DuraciÃ³n paso: $(($(date +%s) - step1_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Registros procesados: \(.registros_procesados // .total // "N/A")" 
              else empty end' 2>/dev/null || echo ""
            echo ""
          } >> execution_log.txt
          
          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: 2ï¸âƒ£ Obtener Procesos SECOP
        id: step2
        if: success()
        run: |
          echo "ðŸ” Paso 2 - Obtener procesos SECOP"
          step2_start=$(date +%s)
          
          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/obtener-procesos-secop" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)
          
          echo "ðŸ“‹ HTTP: $http_code | ðŸ“¦ $size_bytes bytes | â±ï¸ ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"
          
          {
            echo "---------------------------------------------------"
            echo "PASO 2 - Obtener Procesos SECOP"
            echo "---------------------------------------------------"
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status: $http_code"
            echo "TamaÃ±o respuesta: $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API: ${time_seconds}s"
            echo "DuraciÃ³n paso: $(($(date +%s) - step2_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Procesos procesados: \(.procesos_procesados // .total // "N/A")" 
              else empty end' 2>/dev/null || echo ""
            echo ""
          } >> execution_log.txt
          
          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: 3ï¸âƒ£ Obtener Contratos SECOP
        id: step3
        if: success()
        run: |
          echo "ðŸ“„ Paso 3 - Obtener contratos SECOP"
          step3_start=$(date +%s)
          
          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/obtener-contratos-secop" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)
          
          echo "ðŸ“‹ HTTP: $http_code | ðŸ“¦ $size_bytes bytes | â±ï¸ ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"
          
          {
            echo "---------------------------------------------------"
            echo "PASO 3 - Obtener Contratos SECOP"
            echo "---------------------------------------------------"
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status: $http_code"
            echo "TamaÃ±o respuesta: $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API: ${time_seconds}s"
            echo "DuraciÃ³n paso: $(($(date +%s) - step3_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Contratos procesados: \(.contratos_procesados // .total // "N/A")" 
              else empty end' 2>/dev/null || echo ""
            echo ""
          } >> execution_log.txt
          
          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: 4ï¸âƒ£ Obtener Ã“rdenes de Compra TVEC
        id: step4
        if: success()
        run: |
          echo "ðŸ“¦ Paso 4 - Obtener Ã³rdenes de compra TVEC"
          step4_start=$(date +%s)
          
          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/obtener-ordenes-compra-TVEC" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)
          
          echo "ðŸ“‹ HTTP: $http_code | ðŸ“¦ $size_bytes bytes | â±ï¸ ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"
          
          {
            echo "---------------------------------------------------"
            echo "PASO 4 - Obtener Ã“rdenes de Compra TVEC"
            echo "---------------------------------------------------"
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status: $http_code"
            echo "TamaÃ±o respuesta: $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API: ${time_seconds}s"
            echo "DuraciÃ³n paso: $(($(date +%s) - step4_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Ã“rdenes procesadas: \(.ordenes_procesadas // .total // "N/A")" 
              else empty end' 2>/dev/null || echo ""
            echo ""
          } >> execution_log.txt
          
          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: âœ… Finalizar Logs
        if: always()
        run: |
          end_time=$(date +%s)
          start_time=$(cat start_time.txt 2>/dev/null || echo $end_time)
          duration=$((end_time - start_time))
          
          status="${{ job.status }}"
          [ "$status" = "success" ] && icon="âœ…" || icon="âŒ"
          
          {
            echo "=================================================="
            echo "RESUMEN FINAL"
            echo "=================================================="
            echo "Estado: $status $icon"
            echo "Timestamp Fin: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "DuraciÃ³n Total: ${duration}s ($(echo "scale=2; $duration/60" | bc 2>/dev/null || echo "N/A") min)"
            echo "=================================================="
          } >> execution_log.txt
          
          echo ""
          echo "ðŸ“Š RESUMEN DE EJECUCIÃ“N:"
          cat execution_log.txt

      - name: ðŸ“¤ Upload Execution Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emprestito-execution-logs-${{ github.run_number }}
          path: execution_log.txt
          retention-days: 90
