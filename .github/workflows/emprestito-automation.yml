name: Workflow para la ActualizaciÃ³n de datos emprÃ©stito

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0,5,10,15,17,22 * * *"

env:
  API_BASE_URL: ${{ secrets.API_BASE_URL }}
  PROJECT_ID: dev-test-e778d
  FIREBASE_UID: ${{ secrets.FIREBASE_AUTOMATION_UID }}

jobs:
  emprestito-pipeline:
    name: ActualizaciÃ³n de datos emprÃ©stito
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate with Google Cloud WIF
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER_ID }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          project_id: ${{ env.PROJECT_ID }}
          token_format: "access_token"

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install Firebase Admin SDK
        run: |
          pip install firebase-admin google-auth

      - name: ğŸ”‘ Generate Firebase Custom Token
        id: firebase_token
        run: |
          python << 'PYTHON_SCRIPT'
          import firebase_admin
          from firebase_admin import credentials, auth
          import os
          import sys

          try:
              cred = credentials.ApplicationDefault()
              firebase_admin.initialize_app(cred, {
                  'projectId': '${{ env.PROJECT_ID }}'
              })
              
              uid = '${{ env.FIREBASE_UID }}'
              custom_token = auth.create_custom_token(uid)
              
              token_str = custom_token.decode()
              print(f"::add-mask::{token_str}")
              print(f"FIREBASE_TOKEN={token_str}", file=open(os.environ['GITHUB_ENV'], 'a'))
              
              print("âœ… Custom token generado exitosamente")
              print(f"ğŸ”‘ Token para UID: {uid[:8]}...{uid[-4:]}")
              
          except Exception as e:
              print(f"âŒ Error generando token: {e}")
              sys.exit(1)
          PYTHON_SCRIPT

      - name: ğŸ“‹ Inicializar Logs
        run: |
          echo "ğŸš€ Iniciando pipeline de emprÃ©stito"
          echo "â° $(date)"

          echo "==================================================" > execution_log.txt
          echo "WORKFLOW - ActualizaciÃ³n de datos emprÃ©stito" >> execution_log.txt
          echo "==================================================" >> execution_log.txt
          echo "Timestamp Inicio - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> execution_log.txt
          date +%s > start_time.txt
          echo "Ejecutado por - ${{ github.actor }}" >> execution_log.txt
          echo "Trigger - ${{ github.event_name }}" >> execution_log.txt
          echo "Run ID - ${{ github.run_id }}" >> execution_log.txt
          echo "Run Number - ${{ github.run_number }}" >> execution_log.txt
          echo "" >> execution_log.txt

      - name: 1ï¸âƒ£ Crear Tabla de Proyecciones
        id: step1
        run: |
          echo "ğŸ“Š Paso 1: Crear tabla de proyecciones"
          step1_start=$(date +%s)

          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/crear-tabla-proyecciones" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $FIREBASE_TOKEN")

          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)

          echo "ğŸ“‹ HTTP: $http_code | ğŸ“¦ $size_bytes bytes | â±ï¸  ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"

          # Logs
          {
            echo "---------------------------------------------------"
            echo "PASO 1: Crear Tabla de Proyecciones"
            echo "---------------------------------------------------"
            echo "Timest - Crear Tabla de Proyecciones"
            echo "---------------------------------------------------"
            echo "Timestamp - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status - $http_code"
            echo "TamaÃ±o respuesta - $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API - ${time_seconds}s"
            echo "DuraciÃ³n paso - $(($(date +%s) - step1_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Registros -
          } >> execution_log.txt

          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: 2ï¸âƒ£ Obtener Procesos SECOP
        id: step2
        if: success()
        run: |
          echo "ğŸ” Paso 2: Obtener procesos SECOP"
          step2_start=$(date +%s)

          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/obtener-procesos-secop" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $FIREBASE_TOKEN")

          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)

          echo "ğŸ“‹ HTTP: $http_code | ğŸ“¦ $size_bytes bytes | â±ï¸  ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"

          # Logs
          {
            echo "---------------------------------------------------"
            echo "PASO 2 - Obtener Procesos SECOP"
            echo "---------------------------------------------------"
            echo "Timestamp - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status - $http_code"
            echo "TamaÃ±o respuesta - $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API - ${time_seconds}s"
            echo "DuraciÃ³n paso - $(($(date +%s) - step2_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Procesos - \(.total_procesos // .procesos_procesados // "N/A")" 
              else empty end' 2>/dev/null || echo ""
            echo ""
          } >> execution_log.txt

          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: 3ï¸âƒ£ Obtener Contratos SECOP
        id: step3
        if: success()
        run: |
          echo "ğŸ“„ Paso 3: Obtener contratos SECOP"
          step3_start=$(date +%s)

          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/obtener-contratos-secop" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $FIREBASE_TOKEN")

          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)

          echo "ğŸ“‹ HTTP: $http_code | ğŸ“¦ $size_bytes bytes | â±ï¸  ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"

          # Logs
          {
            echo "---------------------------------------------------"
            echo "PASO 3 - Obtener Contratos SECOP"
            echo "---------------------------------------------------"
            echo "Timestamp - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status - $http_code"
            echo "TamaÃ±o respuesta - $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API - ${time_seconds}s"
            echo "DuraciÃ³n paso - $(($(date +%s) - step3_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Contratos - \(.total_contratos // .contratos_procesados // "N/A")" 
              else empty end' 2>/dev/null || echo ""
            echo ""
          } >> execution_log.txt

          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: 4ï¸âƒ£ Obtener Ã“rdenes de Compra TVEC
        id: step4
        if: success()
        run: |
          echo "ğŸ“¦ Paso 4: Obtener Ã³rdenes de compra TVEC"
          step4_start=$(date +%s)

          response=$(curl -s -w "\n%{http_code}\n%{size_download}\n%{time_total}" \
            -X POST "$API_BASE_URL/emprestito/obtener-ordenes-compra-TVEC" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $FIREBASE_TOKEN")

          http_code=$(echo "$response" | tail -n3 | head -n1)
          size_bytes=$(echo "$response" | tail -n2 | head -n1)
          time_seconds=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -3)

          echo "ğŸ“‹ HTTP: $http_code | ğŸ“¦ $size_bytes bytes | â±ï¸  ${time_seconds}s"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"

          # Logs
          {
            echo "---------------------------------------------------"
            echo "PASO 4 - Obtener Ã“rdenes de Compra TVEC"
            echo "---------------------------------------------------"
            echo "Timestamp - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "HTTP Status - $http_code"
            echo "TamaÃ±o respuesta - $size_bytes bytes ($((size_bytes/1024)) KB)"
            echo "Tiempo respuesta API - ${time_seconds}s"
            echo "DuraciÃ³n paso - $(($(date +%s) - step4_start))s"
            echo "$body" | jq -r 'if type=="object" then 
              "Ã“rdenes - \(.total_ordenes // .ordenes_procesadas // "N/A")" 
              else empty end' 2>/dev/null || echo ""
            echo ""
          } >> execution_log.txt

          [ "$http_code" = "200" ] || exit 1
          echo "âœ… Completado"

      - name: âœ… Finalizar Logs
        if: always()
        run: |
          end_time=$(date +%s)
          start_time=$(cat start_time.txt 2>/dev/null || echo $end_time)
          duration=$((end_time - start_time))

          status="${{ job.status }}"
          [ "$status" = "success" ] && icon="âœ…" || icon="âŒ"

          {
            echo "=================================================="
            echo "RESUMEN FINAL"
            echo "=================================================="
            echo "Estado - $status $icon"
            echo "Timestamp Fin - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "DuraciÃ³n Total - ${duration}s ($(echo "scale=2; $duration/60" | bc 2>/dev/null || echo "N/A") min)"
            echo "=================================================="
          } >> execution_log.txt

          echo ""
          echo "ğŸ“Š RESUMEN DE EJECUCIÃ“N:"
          cat execution_log.txt

      - name: ğŸ“¤ Guardar Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emprestito-log-${{ github.run_number }}
          path: execution_log.txt
          retention-days: 90
