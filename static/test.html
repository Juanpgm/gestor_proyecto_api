<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Captura 360</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.success {
            background-color: #28a745;
        }
        .button.danger {
            background-color: #dc3545;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success-msg {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .error-msg {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .info-msg {
            color: #004085;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Captura 360 - URLs en Firebase</h1>
        
        <div class="info-msg">
            ‚úÖ Servidor accesible desde: <strong>http://localhost:8000/static/test.html</strong>
        </div>

        <h2>Configuraci√≥n</h2>
        <div>
            <label>URL del API: 
                <input type="text" id="apiUrl" value="http://localhost:8000" style="width: 300px;">
            </label>
        </div>

        <h2>Tests disponibles</h2>
        <button class="button" onclick="testConexion()">1. Verificar conexi√≥n</button>
        <button class="button" onclick="testCapturaDurante()">2. Captura "Durante" (3 URLs)</button>
        <button class="button" onclick="testCapturaAntes()">3. Captura "Antes" (2 URLs)</button>
        <button class="button" onclick="testCapturaDespues()">4. Captura "Despu√©s" (1 URL)</button>
        <button class="button" onclick="testValidacionURLs()">5. Validaci√≥n de URLs</button>
        <button class="button danger" onclick="limpiarOutput()">Limpiar</button>

        <h2>Resultado</h2>
        <div id="output" class="output">Esperando pruebas...</div>
    </div>

    <script>
        const output = document.getElementById('output');
        const apiUrlInput = document.getElementById('apiUrl');

        function log(mensaje, tipo = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const clase = tipo === 'success' ? 'success-msg' : tipo === 'error' ? 'error-msg' : 'info-msg';
            
            if (output.innerHTML === 'Esperando pruebas...') {
                output.innerHTML = '';
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.className = clase;
            msgDiv.textContent = `[${timestamp}] ${mensaje}`;
            output.appendChild(msgDiv);
            output.scrollTop = output.scrollHeight;
        }

        function limpiarOutput() {
            output.innerHTML = 'Esperando pruebas...';
        }

        async function testConexion() {
            const apiUrl = apiUrlInput.value;
            log(`üì° Probando conexi√≥n a ${apiUrl}...`);
            
            try {
                const response = await fetch(`${apiUrl}/docs`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html'
                    }
                });
                
                if (response.ok) {
                    log(`‚úÖ Servidor accesible (Status: ${response.status})`, 'success');
                } else {
                    log(`‚ö†Ô∏è Servidor respondi√≥ con Status: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                log(`Detalle: ${error.stack}`);
            }
        }

        async function crearCaptura(upidSufijo, estado360, urls) {
            const apiUrl = apiUrlInput.value;
            const upid = `TEST-${upidSufijo}-${Date.now()}`;
            
            log(`\nüì∏ Creando captura: ${upid}`);
            log(`Estado: ${estado360}, URLs: ${urls.length}`);
            
            try {
                const formData = new FormData();
                formData.append('upid', upid);
                formData.append('nombre_up', 'Proyecto de Prueba');
                formData.append('nombre_up_detalle', 'Test desde navegador');
                formData.append('descripcion_intervencion', 'Intervenci√≥n test');
                formData.append('solicitud_intervencion', 'SOL-TEST-001');
                
                // nombre_centro_gestor y solicitud_centro_gestor como LISTAS
                formData.append('nombre_centro_gestor', 'Centro de Prueba');
                formData.append('solicitud_centro_gestor', 'Solicitud test');
                
                formData.append('estado_360', estado360);
                formData.append('requiere_alcalde', 'false');
                formData.append('entrega_publica', 'true');
                formData.append('tipo_visita', 'Verificaci√≥n');
                
                // registrado_por como STRINGS directos
                formData.append('registrado_por_username', 'Usuario Test');
                formData.append('registrado_por_email', 'test@example.com');
                
                // coordinates como STRINGS directos
                formData.append('coordinates_type', 'Point');
                formData.append('coordinates_data', '[-76.5225, 3.4516]');
                
                urls.forEach((url, idx) => {
                    formData.append('photosUrl', url);
                    log(`   URL ${idx + 1}: ${url}`);
                });

                log(`üì° POST a ${apiUrl}/unidades-proyecto/captura-estado-360`);
                
                const response = await fetch(`${apiUrl}/unidades-proyecto/captura-estado-360`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                log(`üì• Respuesta recibida (Status: ${response.status})`);

                const data = await response.json();

                if (response.ok && data.success) {
                    log(`‚úÖ Captura creada exitosamente`, 'success');
                    log(`Document ID: ${data.document_id}`);
                    log(`URLs procesadas: ${data.photos_uploaded?.length || 0}`);
                    if (data.photos_failed?.length) {
                        log(`URLs fallidas: ${data.photos_failed.length}`, 'error');
                    }
                } else if (response.status === 422) {
                    log(`‚ùå Error 422 - Validaci√≥n fallida`, 'error');
                    log(`Detalles completos:`);
                    log(JSON.stringify(data, null, 2));
                    
                    // Mostrar qu√© campos son requeridos
                    if (data.detail && Array.isArray(data.detail)) {
                        log(`\n‚ö†Ô∏è Campos con problema:`, 'error');
                        data.detail.forEach((error, idx) => {
                            log(`  ${idx + 1}. ${error.loc.join('.')}: ${error.msg}`);
                        });
                    }
                } else {
                    log(`‚ùå Error ${response.status}: ${data.message || 'Error desconocido'}`, 'error');
                    log(`Detalles: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                log(`‚ùå Error en la solicitud: ${error.message}`, 'error');
                log(`Tipo: ${error.name}`);
                log(`Stack: ${error.stack}`);
            }
        }

        function testCapturaDurante() {
            crearCaptura('DURANTE', 'Durante', [
                'https://example.com/fotos/durante_1.jpg',
                'https://example.com/fotos/durante_2.jpg',
                'https://cloudinary.com/fotos/durante_3.jpg'
            ]);
        }

        function testCapturaAntes() {
            crearCaptura('ANTES', 'Antes', [
                'https://example.com/fotos/antes_1.jpg',
                'https://example.com/fotos/antes_2.jpg'
            ]);
        }

        function testCapturaDespues() {
            crearCaptura('DESPUES', 'Despu√©s', [
                'https://example.com/fotos/despues_1.jpg'
            ]);
        }

        function testValidacionURLs() {
            crearCaptura('VALIDACION', 'Antes', [
                'https://valid-url.com/foto.jpg',
                'invalid-url-without-protocol.jpg',
                'ftp://unsupported-protocol.jpg',
                ''
            ]);
        }

        // Test inicial
        log('üü¢ P√°gina cargada y lista para pruebas');
        log('Selecciona una prueba del men√∫ arriba');
    </script>
</body>
</html>
